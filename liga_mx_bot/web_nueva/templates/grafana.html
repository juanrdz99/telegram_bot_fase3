{% extends "base.html" %}

{% block title %}Liga MX - Visualización con Grafana{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/grafana.css') }}">
<style>
    .grafana-container {
        padding: 20px;
    }
    
    .dashboard-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }
    
    .dashboard-card {
        flex: 1 0 350px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 15px;
        background-color: white;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .dashboard-card h3 {
        margin-top: 0;
        color: #2c3e50;
        border-bottom: 2px solid #eaeaea;
        padding-bottom: 10px;
    }
    
    .dashboard-card p {
        color: #666;
        margin-bottom: 15px;
    }
    
    .dashboard-card .btn {
        display: inline-block;
        padding: 8px 16px;
        background-color: #009879;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .dashboard-card .btn:hover {
        background-color: #007d63;
    }
    
    .iframe-container {
        width: 100%;
        margin-top: 30px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .grafana-iframe {
        width: 100%;
        height: 600px;
        border: none;
    }
    
    .grafana-info {
        background-color: #f8f9fa;
        border-left: 4px solid #009879;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 0 4px 4px 0;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .direct-link {
        display: inline-block;
        padding: 10px 20px;
        background-color: #2c3e50;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .direct-link:hover {
        background-color: #1a252f;
    }
</style>
{% endblock %}

{% block content %}
<div class="grafana-container">
    <div class="section-header">
        <h1>Visualización con Grafana</h1>
        <a href="{{ url_for('grafana_redirect') }}" class="direct-link" target="_blank">
            <i class="fas fa-external-link-alt"></i> Abrir Grafana
        </a>
    </div>
    
    <div class="grafana-info">
        <p><strong>Grafana</strong> es una plataforma de visualización de datos avanzada que nos permite crear dashboards interactivos para monitorear el rendimiento y las estadísticas de la Liga MX en tiempo real.</p>
        <p>Los dashboards a continuación muestran datos en vivo de la aplicación. Puedes interactuar con ellos directamente aquí o abrir Grafana en una nueva pestaña para una experiencia completa.</p>
    </div>
    
    <div class="dashboard-cards" id="dashboard-cards-container">
        <div class="loading-indicator">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Cargando información de dashboards...</p>
        </div>
    </div>
    
    <!-- Contenedor para el dashboard activo -->
    <div class="iframe-container" id="dashboard-container" style="display: none;">
        <iframe id="grafana-iframe" class="grafana-iframe" src="" frameborder="0" allowfullscreen></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar información de dashboards desde la API
        fetch('/api/grafana-info')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('dashboard-cards-container');
                container.innerHTML = ''; // Limpiar contenido de carga
                
                // Crear tarjetas para cada dashboard
                data.dashboards.forEach(dashboard => {
                    const card = document.createElement('div');
                    card.className = 'dashboard-card';
                    card.innerHTML = `
                        <h3>${dashboard.title}</h3>
                        <p>${dashboard.description}</p>
                        <a href="#" class="btn view-dashboard" data-url="${dashboard.url}">Ver Dashboard</a>
                    `;
                    container.appendChild(card);
                });
                
                // Agregar eventos a los botones
                document.querySelectorAll('.view-dashboard').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const url = this.getAttribute('data-url');
                        loadDashboard(url);
                    });
                });
                
                // Cargar el primer dashboard por defecto
                if (data.dashboards && data.dashboards.length > 0) {
                    loadDashboard(data.dashboards[0].url);
                }
            })
            .catch(error => {
                console.error('Error al cargar información de Grafana:', error);
                const container = document.getElementById('dashboard-cards-container');
                container.innerHTML = `
                    <div class="error-message">
                        <p>Error al cargar la información de Grafana. Por favor, verifica que los servicios estén corriendo.</p>
                        <p>Detalles del error: ${error.message}</p>
                    </div>
                `;
            });
    });
    
    function loadDashboard(url) {
        const container = document.getElementById('dashboard-container');
        const iframe = document.getElementById('grafana-iframe');
        
        // Mostrar el contenedor
        container.style.display = 'block';
        
        // Actualizar la URL del iframe con credenciales básicas
        // Nota: en producción, es mejor usar la autenticación de Grafana
        const grafanaUrl = url + '?kiosk';
        iframe.src = grafanaUrl;
        
        // Desplazarse al iframe
        container.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}
